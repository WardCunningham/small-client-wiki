<!-- DOCTYPE HTML -->
<html>
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
  <title>Federated Wiki</title>
</head>
<body>

<style>
.page {width: 420px; margin: 8px; padding: 35px; border: 1px;}
</style>

<div id="content"></div>
<script src="https://fb.me/react-0.14.6.js"></script>
<script src="https://fb.me/react-dom-0.14.6.js"></script>
<script src="http://fb.me/JSXTransformer-0.12.1.js"></script>
<script src="https://code.jquery.com/jquery-3.1.0.js"></script>
<script type="text/jsx">

var Lineup = React.createClass({
  createInstance: function(site, slug) {
    return {
      id: Math.floor(Math.random() * 1000000000),
      site: site,
      slug: slug
    }
  },
  instancesFromUrl: function(lineupString) {
    var instances = []
    var segments = lineupString.split("/")
    for (i = 0; i < segments.length; i += 2) {
      instances.push(this.createInstance(segments[i], segments[i + 1]))
    }
    return instances
  },
  urlFromInstances: function(instances) {
    return instances.map(function(instance) {
      return instance.site + "/" + instance.slug
    }).join("/")
  },
  alignInstances: function(original, replacement) {
    for (var i = 0; i < replacement.length; i++) {
      var o = original[i]
      var r = replacement[i]
      if (o == undefined || r.site != o.site || r.slug != o.slug) {
        break
      }
      r.id = o.id
    }
    return replacement
  },
  getInitialState: function() {
    return {
      lineup: this.instancesFromUrl(window.location.hash.replace("#", ""))
    }
  },
  appendToLineup: function(event) {
    var detail = event.detail
    var newLineup = this.state.lineup.slice(0);
    newLineup.push(this.createInstance(detail.site, detail.slug))
    this.setState({ lineup: newLineup })
    window.location.hash = "#" + this.urlFromInstances(newLineup)
  },
  onPopstate: function(event) {
    var newLineup = this.instancesFromUrl(window.location.hash.replace("#", ""))
    this.alignInstances(this.state.lineup, newLineup)
    this.setState({ lineup: newLineup })
  },
  componentDidMount: function() {
    window.addEventListener("appendToLineup", this.appendToLineup, false)
    window.addEventListener("popstate", this.onPopstate, false)
  },
  render: function() {
    function toSegment(instance) {
      return <Remote key={instance.id} site={instance.site} slug={instance.slug} />
    }

    return <div>{this.state.lineup.map(toSegment)}</div>
  }
})

var Remote = React.createClass({
    // https://facebook.github.io/react/tips/initial-ajax.html
    getInitialState: function() {
        return {
          title: this.props.slug,
          story: []
        };
      },
    componentDidMount: function() {
        var source = 'http://' + this.props.site + '/' + this.props.slug + '.json'
        this.serverRequest = $.get(source, function (result) {
            this.setState({
                title: result.title,
                story: result.story
            });
        }.bind(this));
    },
    componentWillUnmount: function() {
        this.serverRequest.abort();
    },
    render: function(){
        return (
            <div>
                <Page
                    title={this.state.title}
                    story={this.state.story}
                    site={this.props.site}
                    slug={this.props.slug} />
                <Footer
                    details={[this.props.site, this.props.slug]} />
            </div>
        );
    }
});

var Page = React.createClass({
    render: function(){
        function item(site, slug) {
          return function(item, index){
            var I = plugins[item.type] || Paragraph
            return (<I key={item.id} item={item} site={site} slug={slug} />);
          }
        }

        return (
            <div className="page">
                <h2>{this.props.title}</h2>
                {this.props.story.map(item(this.props.site, this.props.slug))}
            </div>
        );
    }
});

var Paragraph = React.createClass({
    render: function(){
        function splitText(text) {
          return text.split(/(\[https?:.*? .*?\]|\[\[.*?\]\])/)
        }

        function span(site, slug) {
          return function (split, index) {
            if (split.startsWith("[[")) {
              return <InternalLink key={index} text={split} site={site} />
            }
            else if (split.startsWith("[")) {
              return <ExternalLink key={index} text={split} />
            }
            else {
              return <PlainText key={index} text={split} />
            }
          }
        }

        var spans = splitText(this.props.item.text)
        return (
            <div className="item" className={this.props.item.type}>
                <p>{spans.map(span(this.props.site, this.props.slug))}</p>
            </div>
        );
    }
})

var Reference = React.createClass({
  render: function () {
    return (
        <p>
          <a href=''>
            <img style={{width: 16, marginRight: 5}} src={'http://' + this.props.item.site + '/favicon.png'}  />
            {this.props.item.title}</a> â€” {this.props.item.text}
        </p>
    )
  }
})

var plugins = {
  "paragraph": Paragraph,
  "reference": Reference
}

var PlainText = React.createClass({
  render: function() {
    return <span>{this.props.text}</span>
  }
})

var ExternalLink = React.createClass({
  render: function() {
    var m = this.props.text.match(/\[(https?:.*?) (.*?)\]/)
    return <a href={m[1]}>{m[2]} <img src="external-link-ltr-icon.png" /></a>
  }
})

var InternalLink = React.createClass({
  asSlug: function(title) {
    return title.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()
  },
  title: function() {
    var m = this.props.text.match(/\[\[(.*?)\]\]/)
    return m[1]
  },
  handleClick: function(click) {
    var detail = { site: this.props.site, slug: this.asSlug(this.title()) }
    var event = new CustomEvent('appendToLineup', { detail: detail })
    window.dispatchEvent(event)
    click.preventDefault()
  },
  render: function() {
    return <a href="#" onClick={this.handleClick}>{this.title()}</a>
  }
})

var Footer = React.createClass({
    render: function(){
        function li (detail, index){ return (<li key={index}>{detail}</li>); }
        return (
        	<div>
            	{this.props.details.map(li)}
          </div>
        );
    }
});

ReactDOM.render(
  <Lineup />,
  document.getElementById('content')
);

</script>
</body>
</html>
